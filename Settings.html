<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <?!= include('Style'); ?>
</head>
<body>
    <div class="container my-5" style="max-width: 700px;">
        <header class="text-center mb-4">
            <h1 class="fw-bold"><i class="bi bi-person-fill-gear me-2"></i>จัดการสิทธิ์การเข้าถึง</h1>
            <p class="text-muted">กำหนดอีเมลผู้ใช้งานที่สามารถเข้าถึง Dashboard ได้ (1 อีเมลต่อ 1 บรรทัด)</p>
        </header>

        <div id="loading" class="text-center d-none">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <main id="settings-form" class="card">
            <div class="card-body">
                <form>
                    <div class="mb-3">
                        <textarea id="emails" class="form-control" rows="10" placeholder="user1@example.com&#10;user2@example.com"></textarea>
                    </div>
                    <div class="d-flex justify-content-between">
                        <a href="<?= dashboardUrl ?>" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>กลับหน้าหลัก
                        </a>
                        <button type="button" class="btn btn-primary" onclick="saveSettings()">
                            <i class="bi bi-save me-2"></i>บันทึกการเปลี่ยนแปลง
                        </button>
                    </div>
                </form>
            </div>
        </main>
        
        <div id="toast-container"></div>
    </div>

    <script>
      function showLoader() { document.getElementById('loading').classList.remove('d-none'); }
      function hideLoader() { document.getElementById('loading').classList.add('d-none'); }
      
      function showToast(message, isSuccess = true) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${isSuccess ? 'success' : 'danger'} border-0 show`;
        toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
      }
      
      function saveSettings() {
        showLoader();
        const emailsText = document.getElementById('emails').value;
        const emails = emailsText.split('\n').map(e => e.trim()).filter(Boolean); // Split by line, trim, and remove empty lines
        google.script.run
          .withSuccessHandler(response => {
            hideLoader();
            if(response.success){
              showToast('บันทึกข้อมูลสำเร็จ!');
            } else {
              showToast(response.message, false);
            }
          })
          .withFailureHandler(err => {
            hideLoader();
            showToast('เกิดข้อผิดพลาด: ' + err.message, false);
          })
          .saveAuthorizedEmails(emails);
      }

      document.addEventListener('DOMContentLoaded', () => {
        showLoader();
        google.script.run
          .withSuccessHandler(emails => {
            hideLoader();
            document.getElementById('emails').value = emails.join('\n');
          })
          .withFailureHandler(err => {
            hideLoader();
            showToast('ไม่สามารถโหลดข้อมูลได้: ' + err.message, false);
          })
          .getAuthorizedEmails();
      });
    </script>
</body>
</html>
